"""Google ADK root agent for picobot."""

from __future__ import annotations

import os
import platform
from datetime import datetime

from google.adk.agents import LlmAgent

from .skills import get_registry, list_skills, read_skill
from .tools import cron, edit_file, exec_command, list_dir, message, read_file, web_fetch, web_search, write_file


def _build_instruction() -> str:
    now = datetime.now().strftime("%Y-%m-%d %H:%M")
    runtime = f"{platform.system()} {platform.machine()} / Python"
    workspace = os.getenv("PICOBOT_WORKSPACE", os.getcwd())
    skills_summary = get_registry().build_summary()

    return f"""You are picobot, a lightweight skills-first coding assistant.

Current time: {now}
Runtime: {runtime}
Workspace: {workspace}

Your job:
1. Solve user tasks directly.
2. Use local skills when relevant.
3. Keep responses concise and actionable.

Rules:
- This system does not support Telegram/Feishu/Slack/WhatsApp channels.
- Only local, file-based skill loading is supported.
- Before using a skill deeply, call `list_skills` then `read_skill(name)` for the specific skill.
- Do not invent skill content. Always read SKILL.md first.
- Prefer these built-in tools for actions: `read_file`, `write_file`, `edit_file`, `list_dir`, `exec`, `web_search`, `web_fetch`, `message`, `cron`.

Available skills:
{skills_summary}
"""


root_agent = LlmAgent(
    name="picobot",
    model=os.getenv("PICOBOT_MODEL", "gemini-3-flash-preview"),
    instruction=_build_instruction(),
    tools=[
        list_skills,
        read_skill,
        read_file,
        write_file,
        edit_file,
        list_dir,
        exec_command,
        web_search,
        web_fetch,
        message,
        cron,
    ],
)
